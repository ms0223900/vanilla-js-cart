# 購物車 DOM 驗證測試指南

## 測試概述

本測試套件 (`cart-dom.test.js`) 是專門為購物車系統設計的**重構友善**的 DOM 驗證測試。這些測試專注於驗證使用者可觀察的行為和 DOM 狀態變化，而不是內部實現細節，確保在重構 JavaScript 代碼後測試仍然有效。

## 測試設計原則

### 1. 基於 DOM 驗證
- ✅ 測試 DOM 元素的存在和狀態
- ✅ 驗證使用者界面的視覺反饋
- ✅ 檢查使用者互動的結果
- ❌ 不依賴內部變數或函數實現

### 2. 重構友善
- ✅ 測試公共 API 和可觀察行為
- ✅ 驗證最終結果而非執行過程
- ✅ 專注於使用者體驗和功能正確性
- ❌ 不測試實現細節或內部狀態

### 3. 真實環境模擬
- 使用實際的 HTML 檔案內容
- 在真實的 DOM 環境中執行測試
- 模擬真實的使用者互動行為

## 測試覆蓋範圍

### DOM 結構驗證
- 檢查所有必要的 DOM 元素是否存在
- 驗證初始狀態是否正確設置

### 購物車操作測試
- 添加商品的 DOM 反應
- 移除商品的狀態變化
- 更新商品數量的顯示
- 清空購物車的行為

### UI 互動測試
- 控制按鈕的正確顯示
- 點擊事件的 DOM 響應
- 數量控制的互動功能

### 計算和顯示測試
- 單項和總計的正確計算
- 價格顯示的格式化
- 數量變化的即時反映

### 通知系統測試
- 操作通知的正確顯示
- 通知內容的準確性
- 通知元素的 DOM 結構

### 持久化和錯誤處理
- 複雜操作序列的狀態一致性
- 錯誤輸入的優雅處理
- 邊界條件的正確行為

## 使用方式

### 運行測試
```bash
# 運行 DOM 測試套件
npm test -- src/cart-dom.test.js

# 運行所有測試
npm test

# 監視模式
npm test:watch -- src/cart-dom.test.js
```

### 重構後的測試驗證
當您重構 `cart-before-refactored.js` 時：

1. **保持公共 API 不變**：確保主要函數名稱和參數格式保持一致
2. **運行測試**：使用 `npm test -- src/cart-dom.test.js` 驗證行為
3. **檢查結果**：所有測試應該繼續通過

### 測試通過標準
- ✅ DOM 結構完整
- ✅ 使用者互動正常
- ✅ 視覺反饋正確
- ✅ 計算結果準確
- ✅ 錯誤處理優雅

## 重構指導

### 安全重構的函數
以下函數可以安全重構其內部實現，只要保持相同的外部行為：

- `addToCart(product)` - 添加商品到購物車
- `removeFromCart(productId)` - 從購物車移除商品
- `changeQuantity(productId, newQuantity)` - 更新商品數量
- `clearAllCart()` - 清空購物車
- `updateCartCount()` - 更新購物車計數顯示
- `updateCartDisplay()` - 更新購物車顯示
- `calculateTotal()` - 計算總金額
- `showMessage(message)` - 顯示通知訊息

### 必須保持的 DOM 結構
以下 DOM 元素和 ID 必須保持不變：

```html
<!-- 購物車計數 -->
<span id="cart-count">0</span>

<!-- 購物車商品容器 -->
<div id="cart-items"></div>

<!-- 購物車總計 -->
<div id="cart-total"></div>

<!-- 空購物車提示 -->
<div id="empty-cart"></div>
```

### CSS 類別依賴
測試依賴以下 CSS 類別：

- `.cart-item` - 購物車商品項目
- `.quantity` - 數量顯示
- `.quantity-btn` - 數量控制按鈕
- `.remove-btn` - 移除按鈕
- `.clear-cart-btn` - 清空購物車按鈕
- `.notification` - 通知元素
- `.item-total` - 商品小計

## 測試環境設置

### 依賴項目
- `jest` - 測試框架
- `jsdom` - DOM 環境模擬
- `@testing-library/jest-dom` - DOM 測試工具

### 配置文件
測試配置在 `package.json` 中的 `jest` 區段，設置檔案在 `src/setupTests.js`。

## 常見問題

### Q: 重構後測試失敗怎麼辦？
A: 首先檢查是否改變了公共 API 或 DOM 結構。如果是，需要相應更新測試。如果不是，檢查邏輯是否正確實現了預期行為。

### Q: 如何添加新的測試案例？
A: 按照現有測試的模式，專注於 DOM 狀態驗證而不是內部實現。確保測試描述清楚且易於理解。

### Q: 測試運行很慢怎麼辦？
A: DOM 測試本身較重，可以考慮使用 `--maxWorkers=1` 或 `--runInBand` 選項來優化測試執行。

## 總結

這個 DOM 驗證測試套件提供了一個穩固的基礎，讓您可以自信地重構購物車 JavaScript 代碼，同時確保使用者體驗和功能正確性得到保證。測試專注於真實使用場景和可觀察行為，為代碼重構提供了可靠的安全網。
